# Триггер скриптов Home Assistant
Плагин для [Ирины, голосового ассистента](https://github.com/janvarev/Irene-Voice-Assistant)

Данный плагин открывает огромные возможности для Ирины, позволяя запускать голосом скрипты в Home Assistant.

Запросы делаются по [REST API](https://developers.home-assistant.io/docs/api/rest/), благодаря чему отпадает надобность в перезапуске и Ирины, и HA.

Протестировано с версией Home Assistant 2023.3.4

## Как использовать плагин
1. Скачайте репозиторий и положите папку plugins в директорию с репозиторием Ирины (или просто положите файл в plugins)
2. Запустите Ирину вместе с плагином один раз и убедитесь, что в папке `options` появился файл `plugin_hassio_script_trigger.json`
3. Получите "Долгосрочный токен доступа" / [long lived access token](https://developers.home-assistant.io/docs/auth_api/#long-lived-access-token) в своём профиле в Home Assistant
4. Откройте файл `plugin_hassio_script_trigger.json` в текстовом редакторе
5. Замените ссылку напротив `hassio_url` на ссылку вашего Home Assistant, обратите внимание - в конце должен быть символ `/`
6. Впишите ваш токен из пункта 2 напротив `hassio_key`
7. В плагине опционально используется библиотека pymystem3 от yandex, она приводит слова в нормальную словоформу (лампу-> лампа) 
для того, чтобы она заработала надо её дополнительно установить командой `pip install pymystem3`, при первом запуске она 
скачает с yandex словарь

### Поддержка устройств
На данный момент поддерживаются устройства типа `switch` и `sensor`, в планах доделать `climate` (термостаты, котлы), `vacuum` (робот пылесос) и, возможно `person` (ирина, где жена? - на работе)

Тип `light` сделать пока не получится, потому как нет примеров такого устройства


## Принцип работы
- При загрузке плагина запрашиваются все состояния объектов и доступные скрипты, у состояний получается их friendly name, дальнейший поиск осуществляется по этому имени
- В списке скриптов и состояний плагин ищет совпадения фразы и алиаса или friendly name скрипта или устройства (HA позволяет давать названия скриптам на кириллице).
- Если устройство или скрипт нашёлся - делается запрос на его выполнение по "ID объекта"
- Если в скрипте указан текст из описания в специальном формате `ttsreply(текст)` - Ирина озвучит его (для добавления описания к скрипту придется открыть текстовый редактор)

## Примеры управления устройств
- включи лампочки
>включается устройство с именем лампочки 
- выключи лампочки
> устройство "лампочки" выключаются
- какая температура в комнате
>проверяется сенсор с именем `температура в комнате` и приходит ответ: `температура в комнате 30 градусов`
- перезагрузи устройства
>происходит перезагрузка устройств, это удобно, чтобы не перезагружать Ирину при добавлении новых устройств

## Примеры команд и скриптов
1. Вы говорите "ирина хочу спать"

>Скрипт выключает весь свет, в спальне включает ночник и устанавливает комфортную температуру, жалюзи закрываются, ассистент желает вам приятных снов

```YAML
alias: спать
description: ttsreply(Приятных снов)
sequence:
  - service: light.turn_off
    data: {}
    target:
      area_id:
        - kuhnya
        - korridor
        - spalnia
  - service: light.turn_on
    data:
      brightness_pct: 20
      kelvin: 2500
    target:
      entity_id: light.tradfri_lamp_level_light_color_on_off
  - service: climate.set_temperature
    data:
      temperature: 20
    target:
      area_id: spalnia
  - service: switch.turn_on
    data: {}
    target:
      entity_id: switch.blinds_bedroom
mode: single
icon: mdi:bed
```

2. Вы говорите "ирина я буду собираться на работу"

>Скрипт присылает вам на телефон прогноз погоды и примерное время пути, термостат отключается, включается чайник на кухне, ассистент желает  продуктивного дня

3. Вы говорите "ирина сделай свет ярче"

>Жалюзи открываются, включается свет
